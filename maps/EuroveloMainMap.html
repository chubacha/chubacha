
  <!DOCTYPE html>
  <html>
  <head>
    <title>     EuroVelo Route - Start/End in Bayonne, France</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <style>
      body {
        background-color: #cfcfcf; /* Slight grey background */
        margin: 0;
        font-family: Arial, sans-serif;
        overflow-x: hidden;
      }
      #map { 
        height: 70vh; 
        width: 100%; 
        max-width: 100%;
      }
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        font-size: 1.5em;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">Loading Map...</div>
    <h2>     EuroVelo Route - Start/End in Bayonne, France</h2>
    <div id="map"></div>
    <script>
      // Disable touch zoom to prevent accidental zooming on mobile
      function disableTouchZoom(map) {
        map.touchZoom.disable();
        map.scrollWheelZoom.disable();
      }

      // Debounce function to limit rate of function calls
      function debounce(func, wait) {
        var timeout;
        return function executedFunction() {
          var context = this;
          var args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(function() {
            func.apply(context, args);
          }, wait);
        };
      }

      // Pass rows data as a JavaScript variable in the iframe
      var rows = [];  // Serialize rows data

      // Initialize map with performance optimizations
      var map = L.map('map', {
        zoomSnap: 0.25,
        zoomControl: true,
        attributionControl: false,
        preferCanvas: true  // Use canvas renderer for better performance
      }).setView([57.5, 15.5], 3.75);

      // Add a performant tile layer
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
        maxZoom: 16,
        crossOrigin: true  // Improve loading performance
      }).addTo(map);

      // Disable touch zoom to prevent accidental zooming
      disableTouchZoom(map);

      // Style function with zigzag patterns for Ferry and Tunnel
      function getStyleByType(type, color) {
        color = color || '#0000FF';
        switch (type) {
          case 'Bike Path - Even':
            return { color: '#59ffff', weight: 2, opacity: 1 }; // grey-blue
          case 'Bike Path - Odd':
            return { color: '#dc143c', weight: 2, opacity: 1 }; // pink
          case 'Ferry':
            return { 
              color: '#ff8c00', // orange
              weight: 2, 
              opacity: 1,
              dashArray: '2,4' 
            };
          case 'Tunnel':
            return { 
              color: '#800080', // purple
              weight: 2, 
              opacity: 1,
              dashArray: '1,5,10,5'
            };
          default:
            return { color: color, weight: 2, opacity: 1 };
        }
      }

      // Create a layer group to hold all route layers
      var routeLayers = L.layerGroup().addTo(map);

      // Lazily load full route GeoJSON
      function loadFullRoute() {
        fetch('https://raw.githubusercontent.com/chubacha/chubacha/main/kmls/FullRoute100DP.geojson')
          .then(function(response) { return response.json(); })
          .then(function(data) {
            // Ensure data.features is an array and sorted
            var sortedFeatures = Array.isArray(data.features) 
              ? data.features.sort(function(a, b) { 
                  return (a.id || 0) - (b.id || 0); 
                }) 
              : [];
            
            // Create GeoJSON layer for full route
            var fullRouteLayer = L.geoJson(null, {
              style: function(feature) {
                return feature.properties && feature.properties.Type 
                  ? getStyleByType(feature.properties.Type)
                  : { color: '#0000FF', weight: 2, opacity: 1 };
              },
              pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                  radius: 3,
                  fillColor: "#ff7800",
                  color: "#000",
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 0.8
                });
              }
            });

            // Add features to the layer
            fullRouteLayer.addData({
              type: 'FeatureCollection', 
              features: sortedFeatures
            });

            // Add full route layer to layer group
            routeLayers.addLayer(fullRouteLayer);

            // Fit map bounds to full route
            map.fitBounds(fullRouteLayer.getBounds());
          })
          .catch(function(error) { console.error('Error loading full route:', error); });
      }

      // Lazily load KML layers
      function loadKMLLayers() {
        rows.forEach(function(row) {
          // Create a layer for the current KML
          var kmlLayer = L.geoJson(null, {
            style: function() {
              return { color: row.trackColor, weight: 4, opacity: 0.8 };
            }
          });

          // Prepare popup content using traditional concatenation
          var popupContent = 
            '<b>' + (row.legName || '') + '</b><br>' +
            'Track Date: ' + (row.trackDate || 'N/A') + '<br>' +
            'Total Distance: ' + (row.totalDistance || 'N/A') + ' km<br>' +
            'Days Ridden: ' + (row.daysPassed || 'N/A') + '<br>' +
            'Day of Trip: ' + (row.dayOfTrip || 'N/A') + '<br>' +
            (row.blogPostLink ? '<a href="' + row.blogPostLink + '">Blog Post</a>' : '');

          // Add KML data to layer
          omnivore.kml(row.kmlUrl, null, kmlLayer)
            .bindPopup(popupContent)
            .addTo(routeLayers);
        });
      }

      // Load data after page load to improve initial load time
      window.addEventListener('load', function() {
        // Remove loading overlay
        document.getElementById('loading-overlay').style.display = 'none';

        // Lazily load routes
        loadFullRoute();
        loadKMLLayers();
      });

      // Responsive resize handling
      var resizeMap = debounce(function() {
        map.invalidateSize();
      }, 250);
      window.addEventListener('resize', resizeMap);
    </script>
  </body>
  </html>
